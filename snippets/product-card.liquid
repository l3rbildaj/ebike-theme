{% comment %}
  Renders a product card
  Accepts:
  - product_card_product: {Object} Product Liquid object (optional)
  - show_secondary_image: {Boolean} Show the secondary image on hover. Default: false (optional)
  - show_vendor: {Boolean} Show the product vendor. Default: true
  - show_desc: {Boolean} Show the product vendor. Default: false
  - section_id: {String} The ID of the section that contains this card.
  - class: {String} Additional classes to add to the card.
  - columns: {Integer} The number of columns to display. Default: 1
  - color_scheme: {String} Color scheme.
  Usage:
  {% render 'product-card', show_vendor: section.settings.show_vendor %}
{% endcomment %}

{% liquid
  case media_ratio
    when 'landscape'
      assign padding_bottom = '75%'
    when 'portrait'
      assign padding_bottom = '135.7%'
    when 'square'
      assign padding_bottom = '100%'
    else
      assign padding_bottom = '100%'
  endcase
%}

{% if columns != blank %}
  {% assign columns_number = columns | times: 1 %}
{% else %}
  {% assign columns_number = 0 %}
{% endif %}

{% if settings.add_to_cart_enabled
  and product_card_product.selected_or_first_available_variant.available
  and product_card_product.has_only_default_variant
  or product_card_product.options.size == 1
  and settings.enable_color_swatch
  and product_card_product.options[0] == settings.trigger_swatch
  and settings.quickview_show
%}
  {% assign additional_class = 'paddings-small' %}
{% else %}
  {% assign additional_class = '' %}
{% endif %}

{%- if settings.quickview_show or settings.add_to_cart_enabled -%}
  {%- assign first_3d_model = product_card_product.media | where: 'media_type', 'model' | first -%}
  {%- if first_3d_model -%}
    {{ 'component-product-model.css' | asset_url | stylesheet_tag }}
    <link
      id="ModelViewerStyle"
      rel="stylesheet"
      href="https://cdn.shopify.com/shopifycloud/model-viewer-ui/assets/v1.0/model-viewer-ui.css"
      media="print"
      onload="this.media='all'"
    >
    <link
      id="ModelViewerOverride"
      rel="stylesheet"
      href="{{ 'component-model-viewer-ui.css' | asset_url }}"
      media="print"
      onload="this.media='all'"
    >
  {%- endif -%}

  {%- if first_3d_model -%}
    <script type="application/json" id="ProductJSON-{{ product.id }}">
      {{ product_card_product.media | where: 'media_type', 'model' | json }}
    </script>
  {%- endif -%}
{%- endif -%}

{% capture media_style %}
  {%- if media_fit == 'contain' -%}
    object-fit: contain;
  {%- endif -%}
  {%- if media_fit == 'cover' -%}
    object-fit: cover;
  {%- endif -%}
{% endcapture %}

<div
  class="card-wrapper js-color-swatches-wrapper{% if color_scheme != blank %} color-{{ color_scheme }}{% else %} color-{{ settings.card_color_scheme }}{% endif %}"
  data-product="{{ product_card_product.handle }}"
>
  <span class="visually-hidden">{{ product_card_product.title | escape }}</span>

  <div class="card card--product" tabindex="-1">
    <div class="card__inner full-unstyled-link">
      {% comment %} Media block {% endcomment %}
      <div
        class="media media--hover-effect"
        style="padding-bottom: {{ padding_bottom }};"
      >
        {%- if product_card_product.featured_media -%}
          {% liquid
            if media_ratio == 'landscape'
              assign settings_aspect_ratio = 1.33
            elsif media_ratio == 'portrait'
              assign settings_aspect_ratio = 0.73
            else
              assign settings_aspect_ratio = 1
            endif

            assign calc_ratio = 1
            if media_fit == 'cover' and product_card_product.featured_media.aspect_ratio > settings_aspect_ratio
              assign calc_ratio = product_card_product.featured_media.aspect_ratio | divided_by: settings_aspect_ratio | round: 2
            endif
          %}

          {%- if columns_number > 0 -%}
            {%- capture sizes -%}
              {%- if columns_number == 4 -%}
                (min-width: 1440px) calc({{ calc_ratio }} * (100vw - 40px) / 4),
              {%- endif -%}
              {%- if columns_number >= 3 -%}
                (min-width: 1200px) calc({{ calc_ratio }} * (100vw - 40px) / 3),
              {%- endif -%}
              {%- if columns_number >= 2 -%}
                (min-width: 576px) calc({{ calc_ratio }} * ((100vw - 40px) / 2)),
              {%- endif -%}
              calc({{ calc_ratio }} * (100vw - 40px))
            {%- endcapture -%}
          {%- else -%}
            {%- capture sizes -%}
              {%- if media_ratio == 'landscape' or media_ratio == 'square' -%}
                (min-width: 1440px) calc({{ calc_ratio }} * 444px), (min-width: 1200px) calc({{ calc_ratio }} * 302px), (min-width: 990px) calc({{ calc_ratio }} * 444px), (min-width: 576px) 90vw, 100vw
              {%- else -%}
                (min-width: 576px) calc({{ calc_ratio }} * 30.2rem), 100vw
              {%- endif -%}
            {%- endcapture -%}
          {%- endif -%}

          {{
            product_card_product.featured_media
            | image_url: width: product_card_product.featured_media.width
            | image_tag:
              loading: 'lazy',
              class: 'motion-reduce media--first',
              widths: '360, 535, 720, 940, 1066, 1200, 1400, 1600, 1800, 2000, 2200, 2400, 2600',
              sizes: sizes,
              style: media_style
          }}

          {%- if product_card_product.media[1] != null and show_secondary_image -%}
            {{
              product_card_product.media[1]
              | image_url: width: product_card_product.media[1].width
              | image_tag:
                loading: 'lazy',
                class: 'motion-reduce media--second',
                widths: '360, 535, 720, 940, 1066, 1200, 1400, 1600, 1800, 2000, 2200, 2400, 2600',
                sizes: sizes,
                style: media_style
            }}
          {%- endif -%}
        {%- else -%}
          {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
        {%- endif -%}
      </div>

      {% comment %} NOTE: Information top block {% endcomment %}

      <div class="card__information-top">
        {%- if settings.badge_sale_show or settings.badge_soldout_show or settings.badge_custom_show -%}
          <div class="card__badge bold body-small">
            {%- if product_card_product.available == false and settings.badge_soldout_show -%}
              <span class="badge badge--sold-out" aria-hidden="true">
                {{- 'products.product.sold_out' | t -}}
              </span>
            {%- elsif product_card_product.selected_or_first_available_variant.compare_at_price
                > product_card_product.selected_or_first_available_variant.price
              and product_card_product.available
              and settings.badge_sale_show
            -%}
              <span class="badge badge--sale" aria-hidden="true">
                {% if settings.badge_sale_type == 'sale' %}
                  {{- 'products.product.on_sale' | t -}}
                {% else %}
                  {{- 'products.product.on_sale' | t -}}
                  <span>
                    {{
                      product_card_product.selected_or_first_available_variant.compare_at_price
                      | minus: product_card_product.selected_or_first_available_variant.price
                      | times: 100.0
                      | divided_by: product_card_product.selected_or_first_available_variant.compare_at_price
                      | round
                    -}}
                    %
                  </span>
                {% endif %}
              </span>
            {%- endif -%}
            {% if settings.badge_custom_show and product_card_product.metafields.custom.badges != blank %}
              {% if product_card_product.metafields.custom.badges.list? %}
                {% for badge in product_card_product.metafields.custom.badges.value %}
                  <span class="badge badge--custom" aria-hidden="true">
                    {{ badge }}
                  </span>
                {% endfor %}
              {% else %}
                <span class="badge badge--custom" aria-hidden="true">
                  {{ product_card_product.metafields.custom.badges }}
                </span>
              {% endif %}
            {% endif %}
          </div>
        {%- endif -%}
      </div>
    </div>

    {% comment %} NOTE: Special buttons {% endcomment %}
    <div
      class="
        card__links card__links--{{ settings.buttons_layout }} {% if additional_class != '' %} card__links--{{ additional_class }} {% endif %}
        {%- if settings.show_on_mobile -%}card__links--show{%- endif %}
      "
    >
      {% liquid
        assign has_color_swatches = false
        if product_card_product.options.size == 1 and settings.enable_color_swatch
          assign color_trigger = settings.trigger_swatch | strip | newline_to_br | split: '<br />'
          assign name_option = product_card_product.options[0] | handle | strip
          for item in color_trigger
            assign item_temp = item | handle | strip
            if name_option == item_temp
              assign has_color_swatches = true
            endif
          endfor
        endif
      %}

      {%- if settings.add_to_cart_enabled
        and product_card_product.selected_or_first_available_variant.available
        and product_card_product.has_only_default_variant
        or has_color_swatches
      -%}
        {%- assign product_form_id = 'quick-add-' | append: section_id | append: product_card_product.id -%}
        <product-form class="card__add-to-cart card__button">
          {%- form 'product',
            product_card_product,
            id: product_form_id,
            class: 'form',
            novalidate: 'novalidate',
            data-type: 'add-to-cart-form'
          -%}
            <input
              type="hidden"
              name="id"
              value="{{ product_card_product.selected_or_first_available_variant.id }}"
              disabled
            >
            <button
              id="{{ product_form_id }}-submit"
              type="submit"
              class="card__link button button--{{ settings.add_to_cart_button_style }} card-focused"
              name="add"
              aria-haspopup="dialog"
              aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ product_card_product.id }}"
              aria-live="polite"
              data-sold-out-message="true"
              {% if product_card_product.selected_or_first_available_variant.available == false %}
                disabled
              {% endif %}
              aria-label="{{ settings.add_to_cart }}"
            >
              <div class="button__content">
                <span class="card__quickadd-text button__label" data-label="{{ settings.add_to_cart }}">
                  {{ settings.add_to_cart }}
                </span>
                <span class="card__mobile-icon button__icon">
                  {% render 'icon-quick-add' %}
                </span>
                <span class="sold-out-message hidden button__label">
                  {{ 'products.product.sold_out' | t }}
                </span>
              </div>
              <div class="animated-button-circle"></div>
              <div class="loading-overlay__spinner hidden">
                {% render 'icon-loading' %}
              </div>
            </button>
          {%- endform -%}
        </product-form>
      {%- endif -%}
      {%- if settings.quickview_show -%}
        <div class="quick-add no-js-hidden">
          {%- assign product_form_id = 'quick-view-' | append: section_id | append: product_card_product.id %}
          <modal-opener data-modal="#QuickAdd-{{ product_card_product.id }}">
            <button
              id="{{ product_form_id }}-submit"
              type="submit"
              name="add"
              class="card__link button button--{{ settings.quickview_button_style }} card-focused"
              aria-haspopup="dialog"
              aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ product_card_product.id }}"
              data-product-url="{{ product_card_product.url }}"
              aria-label="{{ settings.more_label }}"
            >
              <div class="button__content">
                <span class="card__quickview-text button__label" data-label="{{ settings.more_label }}">
                  {{ settings.more_label }}
                </span>
                <span class="card__mobile-icon button__icon">
                  {% render 'icon-quick-view' %}
                </span>
              </div>
              <div class="animated-button-circle"></div>
              <div class="loading-overlay__spinner hidden">
                {% render 'icon-loading' %}
              </div>
            </button>
          </modal-opener>
          <quick-add-modal
            id="QuickAdd-{{ product_card_product.id }}"
            class="quick-add-modal"
          >
            <div
              role="dialog"
              aria-modal="true"
              aria-label="{{ 'products.product.choose_product_options' | t: product_name: product_card_product.title | escape }}"
              quick-add-modalaria-modal="true"
              class="quick-add-modal__content global-settings-popup"
              tabindex="-1"
            >
              <div class="quick-add-modal__content-wrapper">
                <div class="quick-add-modal__top">
                  <p>{{ 'general.card.quick__view' | t }}</p>
                  <button
                    id="ModalClose-{{ product_card_product.id }}"
                    type="button"
                    class="quick-add-modal__toggle modal-close-button focus-inset"
                    aria-label="{{ 'accessibility.close' | t }}"
                  >
                    {{ 'accessibility.close' | t }}
                  </button>
                </div>
                <div
                  id="QuickAddInfo-{{ product_card_product.id }}"
                  class="quick-add-modal__content-info"
                ></div>
              </div>
            </div>
          </quick-add-modal>
        </div>
      {%- endif -%}
    </div>

    <a
      href="{{ product_card_product.url | default: '#' }}"
      class="link link--overlay card-wrapper__link--overlay js-color-swatches-link"
      aria-label="{{ 'accessibility.product_link' | t }}"
    ></a>
  </div>
  {% comment %} NOTE: Card information {% endcomment %}
  <div class="card-information">
    <div class="card-information__wrapper">
      <div class="card-information__group">
        {%- if show_vendor -%}
          <span class="visually-hidden">{{ 'accessibility.vendor' | t }}</span>
          <div class="card__vendor subtitle body-small {% if settings.enable_vendor_link %} card__vendor_link {% endif %}">
            {% if settings.enable_vendor_link %}
              {{ product_card_product.vendor | link_to_vendor: class: 'focus-inset' }}
            {% else %}
              {{ product_card_product.vendor }}
            {% endif %}
          </div>
        {%- endif -%}
        <{{ heading_tag }} class="card__title h5">
          <a class="full-unstyled-link" href="{{ product_card_product.url | default: '#' }}">
            {{- product_card_product.title | escape -}}
          </a>
        </{{ heading_tag }}>
        {%- if show_desc and product_card_product.description != blank -%}
          <div class="card__description">
            {{ product_card_product.description | strip_html | truncate: 120 }}
          </div>
        {%- endif -%}
      </div>

      {% render 'price', product: product_card_product, price_class: '' %}

      {% comment %} NOTE: Parameters {% endcomment %}
      <div class="product-parameters">
        {%- unless product_card_product.has_only_default_variant -%}
          {%- for option in product_card_product.options_with_values -%}
            {%- liquid
              assign is_color_option = false
              assign color_trigger = settings.trigger_swatch | strip | newline_to_br | split: '<br />'
              assign name_option = option.name | handle | strip
              for item in color_trigger
                assign item_temp = item | handle | strip
                if settings.enable_color_swatch and name_option == item_temp
                  assign is_color_option = true
                endif
              endfor
            -%}
            {%- if is_color_option and option.values.size > 1 -%}
              <div class="product-form__controls js-color-swatches">
                <div class="product-form__controls-group">
                  {% render 'product-variant-options',
                    product: product_card_product,
                    section_id: section_id,
                    option: option,
                    is_product_card: true,
                    has_color_swatch: true
                  %}
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        {%- endunless -%}
      </div>
    </div>
  </div>
</div>
